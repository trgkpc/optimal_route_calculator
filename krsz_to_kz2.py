#!/usr/bin/python3.6
from basic import *

mergin = 0.107 + 0.15
zone_mergin = 0.05
ball_mergin = 0.107 + 0.2

init_r =  [ 0.5 ,2.05 ,3.141592653589793] 

# 計算結果(2020年7月18日)
vias_data = [
    [2.6525778031327127, [1.2105170774745262, -0.6101632417858707, 0.06684433496045387], [2.1890677719132894, -0.8228576717854479, 0.12809286736705303]],
    [1.116493505754327, [-0.6716048564539053, 0.871167782996351, -0.0003166834350569625], [-1.0296082775998672, 0.8271099835154159, -0.05283135540054152]],
    [1.0000000000029554, [-1.5260945556043035, 1.968431986078982, -2.4391100676386902e-05], [-0.7957986687292916, -0.34307507130418863, -1.1539811261019275e-05]],
]

# 計算結果(2020年7月22日, 最後の経路を直線的にする手続きを取った)
vias_data = [
    [2.3859845400743556, [2.0063988823259886, -0.9918316916208588, 0.15285715609637313], [3.673535858454393, -1.380368458441655, 0.2719723205805422]],
    [1.565832224178263, [1.0704839837097524, -0.521763176404945, 0.09830788544256365], [-0.7216314066834921, 0.37888898181707853, -0.023333892022219867]],
    [0.9999999999999972, [-0.11998197101080671, 2.688607100230398, 0.00010072579417303213], [0.07242116833271695, -1.621158766062417, 5.16523832564532e-05]],
]

# 計算結果(2020年7月22日, merginを100mmから150mmに増やした)
vias_data = [
    [2.459561079155314, [2.0401824130737793, -0.9020393288519737, 0.12804232593783524], [3.7549008882807358, -1.3150803997446476, 0.24006291300445173]],
    [1.6211714150445093, [2.211166301335202, -0.9537133398928245, 0.12773990850199543], [-0.4403235967067075, 0.3077761542292018, -0.03544673947949098]],
    [1.0000156010359817, [-0.37398585567519527, 2.5400310678915945, -0.000303136280160916], [0.27008094476558825, -1.835011041888096, -0.0001466926438412626]],
]

# 計算結果(2020年7月22日, 最後の経路を1.0secから0.8secにした)
vias_data = [
    [2.675690485658338, [1.5737490263219245, -0.7839645946782798, 0.06138472814837909], [2.8647837164774783, -1.0724125008504934, 0.13018844753063932]],
    [1.3669067918021878, [1.388528581398728, 0.24430481457290298, 0.12277119083818751], [-0.29066766477274425, 0.38934961043576755, -0.015585885164889863]],
    [0.8554509309247698, [-0.42769057582493253, 2.3796653804148375, 1.9053535252422183e-05], [0.28106057870577483, -1.5648336924298833, 1.3392411282774955e-05]],
]



x0 = expand(vias_data)

gen_poll_route = lambda num:gen_poll_route_strict(init_r, num, p5, machine_size, mergin, N=14)

theta_range = [5.0,40000]
#theta_range = [math.pi, 2.0*math.pi]

cons = (
    # ポールに当たらない制約
    gen_poll_route(0),
    gen_poll_strict(init_r, 0, p5, machine_size, mergin, mode='ineq'),
    gen_poll_route(1),
    gen_poll_strict(init_r, 1, p5, machine_size, mergin, mode='ineq'),
    gen_poll_route(2),
    gen_poll_strict(init_r, 2, p5, machine_size, mergin, mode='ineq'),
    # 途中の点を「ここらへんにおく」という制約
    gen_center_in_area(init_r, 0, [[2.0, 3.6], [1.2, p5[1]], theta_range]),
    gen_center_in_area(init_r, 1, [[2.8, 4.5], [1.2, 5.0], theta_range]),
    gen_center_in_area(init_r, 2, [[2.8, 4.0], [1.2, 5.0], theta_range]),
    # 最後の経路の制約
    gen_last_route_not_rotate_strict(),
    gen_last_route_const_acc_strict(),
    # 経路終点の制約
    gen_kickable(init_r, -1, goll_post),
    gen_in_kz2(init_r, -1, machine_size, zone_mergin),
    gen_kick_ball_reachable(init_r, goll_post, p3, ball_mergin),
    gen_stop_check(init_r,-1),
    # 時間を遡らないという制約
    gen_forward_check(0),
    gen_forward_check(1),
    gen_forward_check(2),
    gen_forward_check(-1,0.8),
)

# optimize(init_r, mergin, x0, cons, maxiter=100, visualize=True):
optimize(init_r, mergin, x0, cons, "krsz_to_kz2", maxiter=2000)




